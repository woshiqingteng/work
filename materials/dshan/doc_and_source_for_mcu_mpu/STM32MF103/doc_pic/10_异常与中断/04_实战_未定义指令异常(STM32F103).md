# 实战_未定义指令异常

要想深入理解异常处理，需要写程序来验证。
本节课程故意执行一条未定义的指令，让它触发异常。

参考资料：`ARM Cortex-M3与Cortex-M4权威指南.pdf`、`DDI0403E_B_armv7m_arm.pdf`、`PM0056.pdf`

## 1.1 M3_M4支持哪些异常

从向量表可以看出，M3/M4支持哪些异常：

```
__Vectors       DCD     __initial_sp               ; Top of Stack
                DCD     Reset_Handler              ; Reset Handler
                DCD     NMI_Handler                ; NMI Handler
                DCD     HardFault_Handler          ; Hard Fault Handler
                DCD     MemManage_Handler          ; MPU Fault Handler
                DCD     BusFault_Handler           ; Bus Fault Handler
                DCD     UsageFault_Handler         ; Usage Fault Handler
                DCD     0                          ; Reserved
                DCD     0                          ; Reserved
                DCD     0                          ; Reserved
                DCD     0                          ; Reserved
                DCD     SVC_Handler                ; SVCall Handler
                DCD     DebugMon_Handler           ; Debug Monitor Handler
                DCD     0                          ; Reserved
                DCD     PendSV_Handler             ; PendSV Handler
                DCD     SysTick_Handler            ; SysTick Handler
                
                ; External Interrupts
                DCD     WWDG_IRQHandler            ; Window Watchdog
                DCD     PVD_IRQHandler             ; PVD through EXTI Line detect   
```

前面几个对应各类错误：

* Hard Fault
* MPU Fault
* Bus Fault
* Usage Fault

这几类错误产生的原因入下图所示，这个图来自`ARM Cortex-M3与Cortex-M4权威指南.pdf`:
![](lesson\exception_irq\009_m3m4_fault.png)

以未定义指令为例，它属于"处理器操作相关的错误"，如果没有使能"Usage Fault"，发就会触发"Hard Fault"。



## 1.2 什么是未定义指令？

未定义指令，即使"还没有定义的指令"，也就是CPU不认识的指令。
很多时候，我们故意在代码里插入一些伪造的指令，故意让CPU执行到它时触发错误。
这在调试时很有用，比如想打断点：怎么实现呢？
有很多种方法：硬件监视点(watch point，数量有限)、软件断点(数量无限)。
软件断点就是使用`未定义指令`来实现的，比如想让程序执行到某个地址A时停下来，可以这样做：

* 地址A上原来的指令是`xxx`
* 我们故意把它改成`yyy`，改成一条CPU无法识别的指令
* 当CPU执行到地址A上的`yyy`指令时，触发异常
* 在异常处理函数里，打印更多调试信息
* 调试完毕后，恢复地址A上的指令为`xxx`
* 从地址A重新执行程序

本节教程并不打算制作调试器，这里只是讲述一下未定义指令的作用，使用它来深入理解异常处理流程。



## 1.3 在汇编代码里插入未定义指令

在代码中插入：

```
DCD  0xffffffff
```

看看会发生什么事情。

 

### 1.3.1 先不使能"Usage Fault"



### 1.3.2 使能"Usage Fault"

```

```

### 1.3.3 提供"Usage Fault"的出来函数



### 1.3.4 从"Usage Fault"中恢复